import numpy as np
import matplotlib.pyplot as plt

def calculate_and_plot(ext_pH4, ext_pH5):
    # Constants for Nernst Equation
    R = 8.314  # Gas constant (J/(mol*K))
    T = 298.15  # Temperature (K)
    F = 96485  # Faraday's constant (C/mol)
    E0_hexacyanoferrat = 0.36  # Standard potential for Fe2+/Fe3+ (V)

    # 1. Calculate % oxidized DCPIP
    perc_pH4 = [ext / ext_pH4[-1] * 100 for ext in ext_pH4]
    perc_pH5 = [ext / ext_pH5[-1] * 100 for ext in ext_pH5]

    # 2. Plot % oxidized DCPIP vs Volume of Fe²⁺
    vol_Fe2_pH4 = [1000, 900, 800, 750, 700, 650, 600, 550, 500, 400, 300, 200, 100, 0]
    vol_Fe2_pH5 = [1000, 975, 950, 925, 900, 875, 850, 825, 800, 700, 600, 400, 200, 0]

    plt.figure(figsize=(10, 5))
    plt.plot(vol_Fe2_pH4, perc_pH4, 'o-', label="pH 4.0 (546 nm)")
    plt.plot(vol_Fe2_pH5, perc_pH5, 'o-', label="pH 5.0 (578 nm)")
    plt.xlabel("Volume of Fe²⁺ (µL)")
    plt.ylabel("% Oxidized DCPIP")
    plt.title("Oxidized DCPIP as a Function of Fe²⁺ Volume")
    plt.legend()
    plt.grid()
    plt.show()

    # 3. Find the 50% point and calculate the Fe³⁺/Fe²⁺ ratio
    def find_50_percent(volumes, percentages):
        closest_index = np.argmin(np.abs(np.array(percentages) - 50))
        vol_Fe2 = volumes[closest_index]
        vol_Fe3 = 1200 - vol_Fe2  # Total volume of Fe³⁺ + Fe²⁺ = 1200 µL
        ratio = vol_Fe3 / vol_Fe2
        return vol_Fe2, vol_Fe3, ratio

    vol2_50_pH4, vol3_50_pH4, ratio_pH4 = find_50_percent(vol_Fe2_pH4, perc_pH4)
    vol2_50_pH5, vol3_50_pH5, ratio_pH5 = find_50_percent(vol_Fe2_pH5, perc_pH5)

    # 4. Calculate potential using the Nernst equation
    def calculate_potential(ratio):
        return E0_hexacyanoferrat + (R * T / F) * np.log(ratio)

    potential_pH4 = calculate_potential(ratio_pH4)
    potential_pH5 = calculate_potential(ratio_pH5)

    # Print results
    print("Calculated Percentages:")
    print(f"pH 4.0: {perc_pH4}")
    print(f"pH 5.0: {perc_pH5}\n")

    print("50% Points and Ratios:")
    print(f"pH 4.0: Fe²⁺ Volume = {vol2_50_pH4} µL, Fe³⁺ Volume = {vol3_50_pH4} µL, Ratio = {ratio_pH4:.2f}")
    print(f"pH 5.0: Fe²⁺ Volume = {vol2_50_pH5} µL, Fe³⁺ Volume = {vol3_50_pH5} µL, Ratio = {ratio_pH5:.2f}\n")

    print("Potentials:")
    print(f"pH 4.0 Potential = {potential_pH4:.3f} V")
    print(f"pH 5.0 Potential = {potential_pH5:.3f} V")

# Example input lists (replace these with your actual measured values)
ext_pH4 = [0, 0.012, 0.021, 0.04, 0.062, 0.057, 0.062, 0.053, 0.045, 0.085, 0.087, 0.093, 0.086, 0.105]
ext_pH5 = [0, 0.004, 0.037, 0.004, 0.076, 0.04, 0.213, 0.212, 0.256, 0.275, 0.29, 0.292, 0.27, 0.276]

# Run the function
calculate_and_plot(ext_pH4, ext_pH5)
